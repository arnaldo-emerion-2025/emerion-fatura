unit ManDep;

interface

uses
  Windows, Messages, SysUtils, Classes, Graphics, Controls, Forms, Dialogs,
  Fpadrao, Grids, Wwdbigrd, Wwdbgrid, hGrid, dxExEdtr, dxEdLib, dxEditor,
  StdCtrls, ExtCtrls, Buttons, dxCntner, Menus, Db, Wwdatsrc, DBTables,
  Wwquery, ImgList, dxDBELib, ppBands, ppClass, ppStrtch, ppMemo, ppCtrls,
  ppVar, ppPrnabl, ppCache, ppProd, ppReport, ppDB, ppComm, ppRelatv, ppDBPipe,
  dxColorPickEdit, dxColorEdit, dxColorDateEdit;

type
  TfmManDep = class(TfmPadrao)
    FatDep: TwwQuery;
    FatDe2: TwwQuery;
    DsDe2: TwwDataSource;
    DsDep: TwwDataSource;
    PaintBox: TPaintBox;
    Label16: TLabel;
    Label17: TLabel;
    EdPsqDteDe1: TdxColorDateEdit;
    EdPsqNumRes: TdxColorEdit;
    Label18: TLabel;
    EdPsqDteDe2: TdxColorDateEdit;
    Label26: TLabel;
    Label20: TLabel;
    Label22: TLabel;
    EdPsqCodVen: TdxColorEdit;
    EdPsqCodCli: TdxColorEdit;
    EdPsqCodEmp: TdxColorEdit;
    BbPsqEmp: TSpeedButton;
    BbPsqCli: TSpeedButton;
    BbPsqVen: TSpeedButton;
    EdPsqNomVen: TdxColorEdit;
    EdPsqNomCli: TdxColorEdit;
    EdPsqApeEmp: TdxColorEdit;
    bSelecionar: TBitBtn;
    rgOrdem: TRadioGroup;
    Label1: TLabel;
    EdPsqUfeRes: TdxColorPickEdit;
    Label10: TLabel;
    Bevel1: TBevel;
    Label2: TLabel;
    Bevel2: TBevel;
    grDep: ThGrid;
    Label3: TLabel;
    Bevel3: TBevel;
    grDe2: ThGrid;
    quSql: TwwQuery;
    Label4: TLabel;
    Label5: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    Label9: TLabel;
    pnNomCli: TPanel;
    pnApeVen: TPanel;
    bIncluir: TSpeedButton;
    bEditar: TSpeedButton;
    bImprimir: TSpeedButton;
    bExcluir: TSpeedButton;
    UpDep: TUpdateSQL;
    dbRes: TdxDBGraphicEdit;
    dxDBGraphicEdit1: TdxDBGraphicEdit;
    FatDepCODEMP: TIntegerField;
    FatDepDTERES: TDateTimeField;
    FatDepNUMRES: TIntegerField;
    FatDepSEQLIB: TIntegerField;
    FatDepSEQDEP: TIntegerField;
    FatDepDTEDEP: TDateTimeField;
    FatDepHREDEP: TStringField;
    FatDepQTIDEP: TIntegerField;
    FatDepSEQITE: TIntegerField;
    FatDepQTSDEP: TIntegerField;
    FatDepTOTDEP: TFloatField;
    FatDepTOTGER: TFloatField;
    FatDepBASCOM: TFloatField;
    FatDepTOTCOM: TFloatField;
    FatDepCODUSU: TIntegerField;
    FatDepFLGDEP: TStringField;
    FatDepOBSDEP: TStringField;
    FatDepSEQREG: TStringField;
    FatDepSITDEP: TStringField;
    FatDepCODCLI: TIntegerField;
    FatDepNOMCLI: TStringField;
    FatDepCODVEN: TIntegerField;
    FatDepAPEVEN: TStringField;
    FatDepNOMVEN: TStringField;
    FatDepLOGUSU: TStringField;
    FatDe2CODEMP: TIntegerField;
    FatDe2DTERES: TDateTimeField;
    FatDe2NUMRES: TIntegerField;
    FatDe2SEQLIB: TIntegerField;
    FatDe2SEQDEP: TIntegerField;
    FatDe2SEQDE2: TIntegerField;
    FatDe2SEQRE2: TIntegerField;
    FatDe2CODEIT: TIntegerField;
    FatDe2CODCLP: TStringField;
    FatDe2CODGRU: TStringField;
    FatDe2CODSUB: TStringField;
    FatDe2CODPRO: TStringField;
    FatDe2CODTAM: TStringField;
    FatDe2CODCOR: TStringField;
    FatDe2DESDE2: TStringField;
    FatDe2VLQDE2: TFloatField;
    FatDe2QTLDE2: TFloatField;
    FatDe2ULTQTS: TFloatField;
    FatDe2QTDDE2: TFloatField;
    FatDe2QTDRMA: TFloatField;
    FatDe2SLDDE2: TFloatField;
    FatDe2TOTDE2: TFloatField;
    FatDe2TOTGE2: TFloatField;
    FatDe2BASCOM: TFloatField;
    FatDe2TOTCOM: TFloatField;
    FatDe2NRORE2: TIntegerField;
    FatDe2FLASEQ: TStringField;
    FatDe2DSCPRO: TStringField;
    DsReport: TppDBPipeline;
    ppReport: TppReport;
    ppHeaderBand1: TppHeaderBand;
    ppLabel22: TppLabel;
    ppLabel1: TppLabel;
    ppSystemVariable3: TppSystemVariable;
    ppLabel2: TppLabel;
    ppSystemVariable4: TppSystemVariable;
    TppDetailBand1: TppDetailBand;
    ppCodPro: TppDBText;
    ppDesDe2: TppDBText;
    ppUltQts: TppDBText;
    ppVlqDe2: TppDBText;
    ppTotGe2: TppDBText;
    ppSummaryBand1: TppSummaryBand;
    ppLabel9: TppLabel;
    ppObsDep: TppDBMemo;
    ppTotGer: TppDBText;
    ppLabel10: TppLabel;
    ppGroup1: TppGroup;
    ppGroupHeaderBand1: TppGroupHeaderBand;
    ppLabel3: TppLabel;
    ppLabel4: TppLabel;
    ppLabel6: TppLabel;
    ppLabel7: TppLabel;
    ppApeVen: TppDBText;
    ppApeCli: TppDBText;
    ppNumRes: TppDBText;
    ppNomEmp: TppDBText;
    ppLabel5: TppLabel;
    ppDteRes: TppDBText;
    ppLabel11: TppLabel;
    ppLabel12: TppLabel;
    ppLabel13: TppLabel;
    ppLabel14: TppLabel;
    ppLabel15: TppLabel;
    ppGroupFooterBand1: TppGroupFooterBand;
    FatDe2OBSDEP: TStringField;
    FatDe2TOTGER: TFloatField;
    FatDe2APECLI: TStringField;
    FatDe2NomEmp: TStringField;
    FatDe2APEVEN: TStringField;
    pnSitDep: TPanel;
    FatDepFLGATU: TStringField;
    FatDepMODPFA: TStringField;
    FatDepINTFIN: TStringField;
    FatDepATUEST: TStringField;
    FatDepLANEST: TStringField;
    FatDepCODTIP: TIntegerField;
    FatDepCODFIL: TIntegerField;
    FatDepHRCDEP: TStringField;
    FatDepDTCDEP: TDateTimeField;
    FatDepUSUCFT: TIntegerField;
    FatDepOBSCFT: TMemoField;
    ppQtdRma: TppDBText;
    ppLabel8: TppLabel;
    procedure FormShow(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure BbPsqCliClick(Sender: TObject);
    procedure BbPsqVenClick(Sender: TObject);
    procedure BbPsqEmpClick(Sender: TObject);
    procedure EdPsqNumResExit(Sender: TObject);
    procedure bSelecionarClick(Sender: TObject);
    procedure EdPsqCodEmpExit(Sender: TObject);
    procedure EdPsqCodCliExit(Sender: TObject);
    procedure EdPsqCodVenExit(Sender: TObject);
    procedure EdPsqCodVenKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure EdPsqCodEmpKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure EdPsqCodCliKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure PaintBoxPaint(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure EdPsqNumResKeyPress(Sender: TObject; var Key: Char);
    procedure bEditarClick(Sender: TObject);
    procedure bIncluirClick(Sender: TObject);
    procedure bImprimirClick(Sender: TObject);
    procedure bExcluirClick(Sender: TObject);
    procedure FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure DsDepDataChange(Sender: TObject; Field: TField);
  private
    {Private declarations}
  public
    {Public declarations}
    DteRes: TDateTime;
    sBase, sFiltro, sOrdem: string;
    CodEmp, NumRes, SeqLib, SeqDep: integer;
  end;

var
  fmManDep: TfmManDep;

implementation

uses dxDemoUtils, Bbgeral, Bbfuncao, Bbmensag, ManGDB, PsqEmp, ManPri, AuxPsq,
  AuxIni, ManDe1, FPreview, ManCdp;

{$R *.DFM}

procedure TfmManDep.FormCreate(Sender: TObject);
begin
  inherited;

  EdPsqDteDe1.Date := Date;
  EdPsqDteDe2.Date := Date;

  FatDep.Close;
  FatDep.Params[0].AsDateTime := Date;
  FatDep.Open;

  sBase := ' Select FatDep.*,' +
    '        FinCli.ApeCli as NomCli,' +
    '        FinVen.ApeVen,' +
    '        FinVen.NomVen,' +
    '        GerUsu.LogUsu' +
    ' From FatDep LEFT JOIN PedLib ON (FatDep.CodEmp = PedLib.CodEmp ' +
    '                             AND  FatDep.DteRes = PedLib.DteRes ' +
    '                             AND  FatDep.NumRes = PedLib.NumRes ' +
    '                             AND  FatDep.SeqLib = PedLib.SeqLib)' +
    '             LEFT JOIN FinCli ON (FatDep.CodCli = FinCli.CodCli)' +
    '             LEFT JOIN FinVen ON (FatDep.CodVen = FinVen.CodVen)' +
    '             LEFT JOIN GerUsu ON (FatDep.CodUsu = GerUsu.CodUsu)';

end;

procedure TfmManDep.bSelecionarClick(Sender: TObject);
begin

  ActiveControl := nil;

  if GFlgAce <> 'Sim' then
  begin

    with quSQL, SQL do
    begin

      Close;
      Text := ' Select FLGDEL,SEQIMP from GerPar';
      Open;

      if Trim(FieldbyName('FLGDEL').AsString) = '*' then
      begin

        GFlgAce := 'Sim';

        if FieldbyName('SEQIMP').AsInteger > 0 then GEmpLog := FieldbyName('SEQIMP').AsInteger;

      end
      else
      begin

        GEmpLog := 0;
        GFlgAce := 'Nao';

      end;
    end;
  end;

  sFiltro := '';

  case rgOrdem.Itemindex of
    0: sOrdem := ' Order by FatDep.CodCli,FatDep.NumRes';
    1: sOrdem := ' Order by FatDep.CodVen,FatDep.NumRes';
    2: sOrdem := ' Order by FatDep.DteDep,FatDep.NumRes';
    3: sOrdem := ' Order by FatDep.NumRes';
  end;

  if Trim(EdPsqNumRes.Text) <> '' then sFiltro := sFiltro + ' Where FatDep.NumRes = ''' + EdPsqNumRes.Text + '''';

  if Trim(EdPsqCodEmp.Text) <> '' then
  begin

    if pos('Where', sFiltro) > 0 then
      sFiltro := sFiltro + ' and FatDep.CodEmp = ''' + EdPsqCodEmp.Text + ''''
    else
      sFiltro := ' Where FatDep.CodEmp = ''' + EdPsqCodEmp.Text + '''';

  end;

  if Trim(EdPsqCodCli.Text) <> '' then
  begin

    if pos('Where', sFiltro) > 0 then
      sFiltro := sFiltro + ' and FatDep.CodCli = ''' + EdPsqCodCli.Text + ''''
    else
      sFiltro := ' Where FatDep.CodCli = ''' + EdPsqCodCli.Text + '''';

  end;

  if Trim(EdPsqCodVen.Text) <> '' then
  begin

    if pos('Where', sFiltro) > 0 then
      sFiltro := sFiltro + ' and FatDep.CodVen = ''' + EdPsqCodVen.Text + ''''
    else
      sFiltro := ' Where FatDep.CodVen = ''' + EdPsqCodVen.Text + '''';

  end;

  if Trim(EdPsqUfeRes.Text) <> '' then
  begin

    if pos('Where', sFiltro) > 0 then
      sFiltro := sFiltro + ' and PedLib.UfeLib = ''' + EdPsqUfeRes.Text + ''''
    else
      sFiltro := ' Where PedLib.UfeLib = ''' + EdPsqUfeRes.Text + '''';

  end;

  if Trim(fLimpaStr(EdPsqDteDe1.Text)) <> '' then
  begin

    if pos('Where', sFiltro) > 0 then
      sFiltro := sFiltro + ' and FatDep.DteDep >= ''' + fDateToSQL(EdPsqDteDe1.Date) + ''''
    else
      sFiltro := ' Where FatDep.DteDep >= ''' + fDateToSQL(EdPsqDteDe1.Date) + '''';

  end;

  if Trim(fLimpaStr(EdPsqDteDe2.Text)) <> '' then
  begin

    if pos('Where', sFiltro) > 0 then
      sFiltro := sFiltro + ' and FatDep.DteDep <= ''' + fDateToSQL(EdPsqDteDe2.Date) + ''''
    else
      sFiltro := ' Where FatDep.DteDep <= ''' + fDateToSQL(EdPsqDteDe2.Date) + '''';

  end;

  if GFlgAce = 'Sim' then
  begin

    if pos('Where', sFiltro) > 0 then
      sFiltro := sFiltro + ' and FatDep.SitDep = ' + QuotedStr('Transferencias')
    else
      sFiltro := ' Where FatDep.SitDep = ' + QuotedStr('Transferencias');

  end;

  with FatDep, SQL do
  begin

    Close;
    Text := sBase + sFiltro + sOrdem;
    Open;

  end;

  grDep.SetFocus;

end;

procedure TfmManDep.EdPsqCodEmpExit(Sender: TObject);
begin
  if Trim(EdPsqCodEmp.Text) <> '' then
  begin

    if GFlgAce <> 'Sim' then
    begin

      with quSQL, SQL do
      begin

        Close;
        Text := ' Select FLGDEL,SEQIMP from GerPar';
        Open;

        if Trim(FieldbyName('FLGDEL').AsString) = '*' then
        begin

          GFlgAce := 'Sim';

          if FieldbyName('SEQIMP').AsInteger > 0 then GEmpLog := FieldbyName('SEQIMP').AsInteger;

        end
        else
        begin

          GEmpLog := 0;
          GFlgAce := 'Nao';

        end;
      end;
    end;

    with quSql, SQL do
    begin

      Close;
      Text := ' Select ApeEmp From GerEmp Where GerEmp.CodEmp = ' + QuotedStr(EdPsqCodEmp.Text);
      Open;

      if Trim(FieldByName('ApeEmp').AsString) <> '' then
        EdPsqApeEmp.Text := FieldByName('ApeEmp').AsString
      else
      begin

        EdPsqApeEmp.Text := '';

        fmsgErro('Empresa Informada não Encontrada.', EdPsqCodEmp);

      end;
    end;

  end
  else
    EdPsqApeEmp.Text := '';
end;

procedure TfmManDep.EdPsqCodCliExit(Sender: TObject);
begin
  if Trim(EdPsqCodCli.Text) <> '' then
  begin

    with quSql, SQL do
    begin

      Close;
      Text := 'Select NomCli From FinCli Where CodCli = ''' + EdPsqCodCli.Text + '''';
      Open;

      EdPsqNomCli.Text := quSql.FieldByName('NomCli').AsString;
    end;

  end
  else
    EdPsqNomCli.Text := '';
end;

procedure TfmManDep.BbPsqEmpClick(Sender: TObject);
begin
  inherited;

  try

    fmPsqEmp := TfmPsqEmp.Create(Self);
    fmPsqEmp.ShowModal;

    if fmPsqEmp.CodEmp > 0 then
    begin

      EdPsqApeEmp.Text := fmPsqEmp.ApeEmp;
      EdPsqCodEmp.Text := IntToStr(fmPsqEmp.CodEmp);

    end;

  finally

    FreeAndNil(fmPsqEmp);

  end;
end;

procedure TfmManDep.EdPsqCodEmpKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if key = 112 then
  begin {F1 - Iniciais}

    try

      fmPsqEmp := TfmPsqEmp.Create(Self);
      fmPsqEmp.ShowModal;

      if fmPsqEmp.CodEmp > 0 then
      begin

        EdPsqApeEmp.Text := fmPsqEmp.ApeEmp;
        EdPsqCodEmp.Text := IntToStr(fmPsqEmp.CodEmp);

      end;

    finally

      FreeAndNil(fmPsqEmp);

    end;

    EdPsqCodEmp.SetFocus;

  end;
end;

procedure TfmManDep.EdPsqCodCliKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if key = 112 then
  begin {F1 - Iniciais}

    try

      fmAuxIni := TfmAuxIni.Create(Self);

      fmAuxIni.TipoPesq := 'C';

      fmAuxIni.ShowModal;

      if fmAuxIni.CodCli > 0 then
      begin

        EdPsqNomCli.Text := fmAuxIni.NomCli;
        EdPsqCodCli.Text := IntToStr(fmAuxIni.CodCli);

      end;

    finally

      FreeAndNil(fmAuxIni);

    end;
  end;

  if key = 113 then
  begin {F2 - Inteligente/Nome}

    try

      fmAuxPsq := TfmAuxPsq.Create(Self);

      fmAuxPsq.TipoPesq := 'C';

      fmAuxPsq.ShowModal;

      if fmAuxPsq.CodCli > 0 then
      begin

        EdPsqNomCli.Text := fmAuxPsq.NomCli;
        EdPsqCodCli.Text := IntToStr(fmAuxPsq.CodCli);

      end;

    finally

      FreeAndNil(fmAuxPsq);

    end;
  end;
end;

procedure TfmManDep.EdPsqCodVenExit(Sender: TObject);
begin
  if Trim(EdPsqCodVen.Text) <> '' then
  begin

    with quSql, SQL do
    begin

      Close;
      Text := 'Select NomVen From FinVen Where CodVen = ''' + EdPsqCodVen.Text + '''';
      Open;

      EdPsqNomVen.Text := quSql.FieldByName('NomVen').AsString;
    end;

  end
  else
    EdPsqNomVen.Text := '';
end;

procedure TfmManDep.EdPsqCodVenKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if key = 112 then
  begin {F1 - Iniciais}

    try

      fmAuxIni := TfmAuxIni.Create(Self);

      fmAuxIni.TipoPesq := 'V';

      fmAuxIni.ShowModal;

      if fmAuxIni.CodVen > 0 then
      begin

        EdPsqNomVen.Text := fmAuxIni.NomVen;
        EdPsqCodVen.Text := IntToStr(fmAuxIni.CodVen);

      end;

    finally

      FreeAndNil(fmAuxIni);

    end;
  end;

  if key = 113 then
  begin {F2 - Inteligente/Nome}

    try

      fmAuxPsq := TfmAuxPsq.Create(Self);

      fmAuxPsq.TipoPesq := 'V';

      fmAuxPsq.ShowModal;

      if fmAuxPsq.CodVen > 0 then
      begin

        EdPsqNomVen.Text := fmAuxPsq.NomVen;
        EdPsqCodVen.Text := IntToStr(fmAuxPsq.CodVen);

      end;

    finally

      FreeAndNil(fmAuxPsq);

    end;
  end;
end;

procedure TfmManDep.BbPsqCliClick(Sender: TObject);
begin

  try

    fmAuxIni := TfmAuxIni.Create(Self);

    fmAuxIni.TipoPesq := 'C';

    fmAuxIni.ShowModal;

    if fmAuxIni.CodCli > 0 then
    begin

      EdPsqNomCli.Text := fmAuxIni.NomCli;
      EdPsqCodCli.Text := IntToStr(fmAuxIni.CodCli);

    end;

  finally

    FreeAndNil(fmAuxIni);

  end;
end;

procedure TfmManDep.BbPsqVenClick(Sender: TObject);
begin

  try

    fmAuxIni := TfmAuxIni.Create(Self);

    fmAuxIni.TipoPesq := 'V';

    fmAuxIni.ShowModal;

    if fmAuxIni.CodVen > 0 then
    begin

      EdPsqNomVen.Text := fmAuxIni.NomVen;
      EdPsqCodVen.Text := IntToStr(fmAuxIni.CodVen);

    end;

  finally

    FreeAndNil(fmAuxIni);

  end;
end;

procedure TfmManDep.EdPsqNumResExit(Sender: TObject);
begin
  if Trim(EdPsqNumRes.Text) <> '' then
  begin

    EdPsqCodEmp.Clear;
    EdPsqApeEmp.Clear;
    EdPsqCodCli.Clear;
    EdPsqNomCli.Clear;
    EdPsqCodVen.Clear;
    EdPsqNomVen.Clear;
    EdPsqUfeRes.Clear;

    EdPsqDteDe1.Clear;
    EdPsqDteDe2.Clear;

  end;
end;

procedure TfmManDep.FormShow(Sender: TObject);
begin
  inherited;
  EdPsqNumRes.SetFocus;
end;

procedure TfmManDep.PaintBoxPaint(Sender: TObject);
begin
  inherited;
  with Sender as TPaintBox do FillGrayGradientRect(PaintBox.Canvas, PaintBox.ClientRect, PaintBox.Color);
end;

procedure TfmManDep.FormDestroy(Sender: TObject);
begin
  inherited;
  fmManDep := nil;
end;

procedure TfmManDep.EdPsqNumResKeyPress(Sender: TObject; var Key: Char);
begin
  inherited;
  if not (key in ['0'..'9']) then key := #0;
end;

procedure TfmManDep.bEditarClick(Sender: TObject);
var
  i: Integer;
  Found: Integer;
begin
  inherited;
  if Trim(UpperCase(GLibAce)) = 'SIM' then
  begin

    if FatDepCodEmp.Value > 0 then
    begin

      Found := -1;

      for i := 0 to Screen.FormCount - 1 do
      begin

        if Screen.Forms[i] is TfmManDe1 then Found := i;

      end;

      if Found >= 0 then
      begin

        fmsg('Existem Devoluções de Romaneio em Andamento.', 'E');

        fmManDe1.WindowState := wsNormal;
        fmManDe1.BringToFront;

      end
      else
      begin

        CodEmp := FatDepCodEmp.Value;
        DteRes := FatDepDteRes.Value;
        NumRes := FatDepNumRes.Value;
        SeqLib := FatDepSeqLib.Value;
        SeqDep := FatDepSeqDep.Value;

        fmManDe1 := TfmManDe1.Create(Self);
        fmManDe1.Show;

      end;
    end;

  end
  else
    fmsgErro(GMensagem_0001, nil);
end;

procedure TfmManDep.bIncluirClick(Sender: TObject);
var
  i: Integer;
  Found: Integer;
begin
  inherited;
  if Trim(UpperCase(GLibAce)) = 'SIM' then
  begin

    Found := -1;

    for i := 0 to Screen.FormCount - 1 do
    begin

      if Screen.Forms[i] is TfmManDe1 then Found := i;

    end;

    if Found >= 0 then
    begin

      fmsg('Existem Devoluções de Romaneio em Andamento.', 'E');

      fmManDe1.WindowState := wsNormal;
      fmManDe1.BringToFront;

    end
    else
    begin

      CodEmp := 0;
      NumRes := 0;
      SeqLib := 0;
      SeqDep := 0;

      fmManDe1 := TfmManDe1.Create(Self);
      fmManDe1.Show;

    end;

  end
  else
    fmsgErro(GMensagem_0001, nil);
end;

procedure TfmManDep.bImprimirClick(Sender: TObject);
var
  i: Integer;
  Found: Integer;
begin
  inherited;
  if FatDe2CodEmp.Value > 0 then
  begin

    Found := -1;

    for i := 0 to Screen.FormCount - 1 do
    begin

      if Screen.Forms[i] is TfmManDe1 then Found := i;

    end;

    if Found >= 0 then
    begin

      fmsg('Existem Devoluções de Romaneio em Andamento.', 'E');

      fmManDe1.WindowState := wsNormal;
      fmManDe1.BringToFront;

    end
    else
    begin

      try

        ppReport.DeviceType := 'Screen';
        fmPreview := TfmPreview.Create(fmManDep);
        fmPreview.ppViewer.Report := ppReport;
        ppReport.PrintToDevices;
        fmPreview.ShowModal;

        if Assigned(ppReport.AfterPrint) then ppReport.AfterPrint(Sender);

      finally

        FreeAndNil(fmPreview);

      end;
    end;
  end;
end;

procedure TfmManDep.bExcluirClick(Sender: TObject);
var
  i: Integer;
  Found: Integer;
begin
  inherited;
  if Trim(UpperCase(GLibAce)) = 'SIM' then
  begin

    if FatDepNumRes.Value > 0 then
    begin

      Found := -1;

      for i := 0 to Screen.FormCount - 1 do
      begin

        if Screen.Forms[i] is TfmManDe1 then Found := i;

      end;

      if Found >= 0 then
      begin

        fmsg('Existem Devoluções de Romaneio em Andamento.', 'E');

        fmManDe1.WindowState := wsNormal;
        fmManDe1.BringToFront;

      end
      else
      begin

        if FatDepSitDep.Value <> 'Concluido' then
        begin

          if fMsg('Confirma a Exclusão do Processo de Devolução ?', 'O') then
          begin

            FatDep.Delete;

            with FatDep do
            begin

              fmManGDB.dbMain.StartTransaction; {Inicia a Transação};

              try

                ApplyUpdates; {Tenta aplicar as alterações};

                fmManGDB.dbMain.Commit; {confirma todas as alterações fechando a transação};

              except

                fmManGDB.dbMain.Rollback; {desfaz as alterações se acontecer um erro};

                if FatDep.State <> dsBrowse then FatDep.CancelUpdates;

                grDep.SetFocus;

                raise;

              end;

              CommitUpdates; {sucesso!, limpa o cache...}

            end;

            FatDep.Close;
            FatDep.Open;

            grDep.SetFocus;

          end;

        end
        else
        begin

          if FatDepSitDep.Value <> 'Cancelado' then
          begin

            try

              fmManCdp := TfmManCdp.Create(Self);

              fmManCdp.ShowModal;

            finally

              FreeAndNil(fmManCdp);

            end;

          end
          else
            fmsgErro('Operação não Pode ser Realizada. Devolução já Cancelada.', nil);

        end;
      end;
    end;

  end
  else
    fmsgErro(GMensagem_0001, nil);
end;

procedure TfmManDep.FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  inherited;

  if key = 27 then close;

  if key = 114 then bEditar.OnClick(Sender);

  if key = 115 then bIncluir.OnClick(Sender);

  if key = 116 then bImprimir.OnClick(Sender);

  if key = 117 then bExcluir.OnClick(Sender);

end;

procedure TfmManDep.FormClose(Sender: TObject; var Action: TCloseAction);
var
  i: Integer;
  Found: integer;
begin
  inherited;

  Found := -1;

  for i := 0 to Screen.FormCount - 1 do
  begin

    if Screen.Forms[i] is TfmManDe1 then Found := i;

  end;

  if Found >= 0 then
    fmsgErro('Existem Devoluções de Romaneio em Andamento.', nil)
  else
    Action := CaFree;

end;

procedure TfmManDep.DsDepDataChange(Sender: TObject; Field: TField);
begin
  inherited;

  pnNomCli.Caption := ' ' + FatDepNomCli.Value;
  pnApeVen.Caption := ' ' + FatDepApeVen.Value;

  pnSitDep.Caption := FatDepSitDep.Value;

end;

end.
